# Настройки проекта для Claude Code

## Язык общения

- **Общение на русском**: Всегда общаться с пользователем на русском языке.
- **Комментарии в коде на английском**: Все комментарии в коде писать только на английском языке.
- **Сообщения коммитов на английском**: Сообщения коммитов писать на английском.

## Правила коммитов

- **Без упоминаний ИИ**: Никогда не включать "Generated with Claude", "Co-Authored-By: Claude", "Anthropic" или любой другой текст связанный с ИИ в сообщения коммитов.
- **Только отслеживаемые файлы**: Коммитить только Modified файлы (уже отслеживаемые git). НЕ добавлять и не коммитить новые/неотслеживаемые файлы. Пользователь добавит новые файлы вручную через TortoiseGit.
- **Ждать добавления файлов**: НЕ делать коммит пока все новые файлы не добавлены пользователем в tracking или pending. Сначала сообщить пользователю о новых файлах и ждать подтверждения.
- **Без автоматического push**: НИКОГДА не делать git push автоматически. Push выполняется ТОЛЬКО по явной просьбе пользователя.
- **Простые сообщения коммитов**: Писать краткие сообщения коммитов на английском, описывающие изменения.
- **Разделение коммитов**: Разные логические изменения должны быть в разных коммитах. Не смешивать несвязанные изменения в одном коммите.

## Режим ревью

- **Без коммитов при ревью**: При выполнении задач код-ревью/валидации НЕ коммитить и не пушить. Только вносить исправления в файлы.
- **Пользователь контролирует git**: Пользователь выполнит все git операции (commit, push) вручную через TortoiseGit.

## Стиль кода

- Использовать табы для отступов в C# файлах.
- Следовать существующим соглашениям кода в проекте.

## Архитектурные принципы

- **Без костылей и workarounds**: Не использовать обходные решения вместо правильной архитектуры.
  ```csharp
  // ПЛОХО - костыль:
  public static IQueryable<T> SkipLong<T>(IQueryable<T> source, long count)
  {
      // Чейнить несколько Skip(int.MaxValue) - неправильно!
      while (count > int.MaxValue)
      {
          source = source.Skip(int.MaxValue);
          count -= int.MaxValue;
      }
  }

  // ХОРОШО - правильная архитектура:
  public static IQueryable<T> SkipLong<T>(IQueryable<T> source, long count)
  {
      // Создать Expression с long параметром, query provider транслирует в SQL
      return source.Provider.CreateQuery<T>(
          Expression.Call(method, source.Expression, Expression.Constant(count)));
  }
  ```
- **Делегировать ответственность правильному слою**: Если query provider должен транслировать в SQL — передать ему правильное Expression, а не пытаться обойти ограничения API.
- **Проверять ограничения API**: Если стандартный API (например `Skip(int)`) не поддерживает нужный тип — создать расширение с правильным Expression, а не цепочку вызовов.

## Правила написания тестов

- **Тесты должны быть детерминированными**: Тест должен либо проходить, либо падать. НЕ писать try-catch с комментариями типа "This is acceptable" или "Both behaviors are valid".
- **Один ожидаемый результат**: Каждый тест проверяет конкретное ожидаемое поведение. Если поведение неопределено — тест не нужен.
- **Без альтернативных путей**: НЕ писать код вида:
  ```csharp
  // ПЛОХО - так НЕ делать:
  try {
      DoSomething();
  } catch (SomeException) {
      // "acceptable" - НЕТ!
  }
  ```
- **Чёткие assertions**: Использовать конкретные проверки (AssertEqual, AssertTrue, ThrowsExactly), а не размытые условия.
- **Тесты проверяют ПРАВИЛЬНОЕ поведение**: Тест должен проверять ожидаемое правильное поведение. Если есть баг — тест падает. Когда баг исправят — тест пройдёт.
- **НЕ использовать Assert.Inconclusive для багов**: Писать тесты с обычными assertions (AssertTrue, AssertEqual и т.д.). Если баг есть — тест упадёт. НЕ писать `if (bugExists) Assert.Inconclusive("bug exists")` — это требует повторного редактирования после фикса.
- **Без упоминаний багов в комментариях**: НЕ писать "BUG:", "Bug:", "This is a bug" в комментариях. Комментарии остаются надолго после исправлений. Просто описывать что тест проверяет.
  ```csharp
  // ПЛОХО:
  /// <summary>
  /// BUG: This method doesn't handle null correctly.
  /// </summary>

  // ХОРОШО:
  /// <summary>
  /// Verifies that null values are handled correctly.
  /// </summary>
  ```
- **CancellationToken из BaseTestClass**: Все тесты должны наследоваться от `BaseTestClass`. При вызове async методов, принимающих `CancellationToken`, использовать свойство `CancellationToken` из базового класса:
  ```csharp
  // ХОРОШО:
  await Task.Delay(100, CancellationToken);
  await SomeAsyncMethod(CancellationToken);

  // ПЛОХО:
  await Task.Delay(100); // без токена
  await SomeAsyncMethod(CancellationToken.None);
  ```

## Работа с багами

- **Сначала тесты**: Когда пользователь сообщает о проблеме, первым делом проверить тесты — почему баг не был отловлен. Добавить недостающие тесты прежде чем фиксить код.

## Редактирование Solution файлов (.sln)

- **НЕ использовать `dotnet sln add`**: Команда добавляет лишние платформы (x64, x86) для ВСЕХ проектов, что приводит к большому diff.
- **Редактировать вручную**: При добавлении проекта в solution редактировать .sln файл вручную:
  1. Добавить `Project(...) = "Name", "Path\Name.csproj", "{GUID}"` после последнего проекта
  2. Добавить 4 строки конфигурации в `GlobalSection(ProjectConfigurationPlatforms)`:
     - `{GUID}.Debug|Any CPU.ActiveCfg = Debug|Any CPU`
     - `{GUID}.Debug|Any CPU.Build.0 = Debug|Any CPU`
     - `{GUID}.Release|Any CPU.ActiveCfg = Release|Any CPU`
     - `{GUID}.Release|Any CPU.Build.0 = Release|Any CPU`
